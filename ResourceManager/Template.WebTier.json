{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "appName": {
      "type": "string"
    },
    "appDomain": {
      "type": "string"
    },
    "regionName": {
      "type": "string"
    }
  },
  "variables": {
    "dataTierResourceGroup": "[replace(resourceGroup().name, 'Web', 'Data')]",
    "appTierResourceGroup": "[replace(resourceGroup().name, 'Web', 'App')]",
    "storageAccountName": "[toLower(concat(parameters('appName'), parameters('regionName')))]",
    "databaseAccountName": "[toLower(parameters('appName'))]",
    "databaseAccountNameDocument": "[concat(variables('databaseAccountName'), '-doc')]",
    "databaseAccountNameTable": "[concat(variables('databaseAccountName'), '-table')]",
    "cacheServiceName": "[toLower(concat(parameters('appName'), '-', parameters('regionName')))]",
    "appServicePlanName": "[concat(parameters('appName'), '-', parameters('regionName'))]",
    "webSiteName": "[toLower(concat(parameters('appName'), '-', parameters('regionName')))]"
  },
  "resources": [
    {
      "apiVersion": "2016-08-01",
      "type": "Microsoft.Web/sites",
      "location": "[resourceGroup().location]",
      "name": "[variables('webSiteName')]",
      "properties": {
        "serverFarmId": "[resourceId(variables('appTierResourceGroup'), 'Microsoft.Web/serverFarms', variables('appServicePlanName'))]",
        "siteConfig": {
          "appSettings": [
            {
              "name": "APPINSIGHTS_INSTRUMENTATIONKEY",
              "value": "96f74a64-bf93-458d-9620-179da85f50a4"
            },
            {
              "name": "App.Region",
              "value": "[parameters('regionName')]"
            },
            {
              "name": "Directory.ClientId",
              "value": "5a5942f5-dfd4-42b4-a82e-37de4cf0ecee"
            },
            {
              "name": "Directory.ClientSecret",
              "value": "n1=Q2u]ZNcC#xV=3"
            },
            {
              "name": "Storage",
              "value": "[concat('DefaultEndpointsProtocol=https;AccountName=', variables('storageAccountName'), ';AccountKey=', listKeys(resourceId(variables('dataTierResourceGroup'), 'Microsoft.Storage/storageAccounts', variables('storageAccountName')), '2017-06-01').primaryKey, ';EndpointSuffix=core.windows.net')]"
            },
            {
              "name": "Cosmos.Document.ReadOnly",
              "value": "[concat('AccountEndpoint=https://', variables('databaseAccountNameDocument'), '.documents.azure.com:443/;AccountKey=', listReadOnlyKeys(resourceId(variables('dataTierResourceGroup'), 'Microsoft.DocumentDB/databaseAccounts', variables('databaseAccountNameDocument')), '2016-03-31').primaryKey)]"
            },
            {
              "name": "Cosmos.Document.ReadWrite",
              "value": "[concat('AccountEndpoint=https://', variables('databaseAccountNameDocument'), '.documents.azure.com:443/;AccountKey=', listKeys(resourceId(variables('dataTierResourceGroup'), 'Microsoft.DocumentDB/databaseAccounts', variables('databaseAccountNameDocument')), '2016-03-31').primaryKey)]"
            },
            {
              "name": "Cosmos.Table.ReadOnly",
              "value": "[concat('DefaultEndpointsProtocol=https;AccountName=', variables('databaseAccountNameTable'), '.documents.azure.com:443/;AccountKey=', listReadOnlyKeys(resourceId(variables('dataTierResourceGroup'), 'Microsoft.DocumentDB/databaseAccounts', variables('databaseAccountNameTable')), '2016-03-31').primaryKey, ';TableEndpoint=https://', variables('databaseAccountNameTable'), '.documents.azure.com')]"
            },
            {
              "name": "Cosmos.Table.ReadWrite",
              "value": "[concat('DefaultEndpointsProtocol=https;AccountName=', variables('databaseAccountNameTable'), '.documents.azure.com:443/;AccountKey=', listKeys(resourceId(variables('dataTierResourceGroup'), 'Microsoft.DocumentDB/databaseAccounts', variables('databaseAccountNameTable')), '2016-03-31').primaryKey, ';TableEndpoint=https://', variables('databaseAccountNameTable'), '.documents.azure.com')]"
            },
            {
              "name": "Cache",
              "value": "[concat(variables('cacheServiceName'), '.redis.cache.windows.net,abortConnect=false,ssl=true,password=', listKeys(resourceId(variables('appTierResourceGroup'), 'Microsoft.Cache/redis', variables('cacheServiceName')), '2017-02-01').primaryKey)]"
            }
          ]
        }
      }
    },
    //{
    //  "apiVersion": "2017-05-01",
    //  "type": "Microsoft.Network/trafficManagerProfiles",
    //  "location": "[resourceGroup().location]",
    //  "name": "[variables('webSiteName')]",
    //  "properties": {
    //  }
    //},
    //{
    //  "apiVersion": "2017-04-02",
    //  "type": "Microsoft.Cdn/profiles",
    //  "location": "[resourceGroup().location]",
    //  "name": "[variables('webSiteName')]",
    //  "properties": {
    //    "sku": {
    //      "name": "Standard"
    //    }
    //  }
    //}
  ],
  "outputs": {}
}