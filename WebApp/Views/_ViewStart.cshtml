@using AzureSkyMedia.PlatformServices;
@using AzureSkyMedia.WebApp.Controllers;

@using Microsoft.AspNetCore.Http;

@{
    HttpRequest request = this.Context.Request;
    HttpResponse response = this.Context.Response;
    string authToken = homeController.GetAuthToken(request, response);
    ViewData["authTokenCookie"] = Constant.HttpCookie.UserAuthToken;
    ViewData["authToken"] = authToken;

    if (!string.IsNullOrEmpty(authToken))
    {
        string attributeName = Constant.UserAttribute.UserId;
        string userId = AuthToken.GetClaimValue(authToken, attributeName);

        attributeName = Constant.UserAttribute.MediaAccountName;
        string accountName = AuthToken.GetClaimValue(authToken, attributeName);

        ViewData["accountContext"] = string.Concat(userId, " (", accountName, ")");
    }

    string settingKey = Constant.AppSettingKey.AppRegion;
    ViewData["appRegion"] = AppSetting.GetValue(settingKey);

    string ampVersion = this.Context.Request.Query["amp-version"];
    if (string.IsNullOrEmpty(ampVersion))
    {
        settingKey = Constant.AppSettingKey.MediaPlayerVersion;
        ampVersion = AppSetting.GetValue(settingKey);
    }
    ViewData["mediaPlayerVersion"] = ampVersion;

    string ampSkin = this.Context.Request.Query["amp-skin"];
    if (string.IsNullOrEmpty(ampSkin))
    {
        settingKey = Constant.AppSettingKey.MediaPlayerSkin;
        ampSkin = AppSetting.GetValue(settingKey);
    }
    ViewData["mediaPlayerSkin"] = ampSkin;

    settingKey = Constant.AppSettingKey.StorageCdnUrl;
    ViewData["storageCdnUrl"] = AppSetting.GetValue(settingKey);

    string requestUrl = string.Concat(request.Host, request.Path, request.QueryString);
    if (requestUrl.Contains("live"))
    {
        ViewData["layoutLive"] = true;
    }

    ViewData["accountSignIn"] = "/account/signin";
    ViewData["accountProfileEdit"] = "/account/profileEdit";

    if (requestUrl.Contains("signiant"))
    {
        ViewData["accountSignIn"] = string.Concat(ViewData["accountSignIn"], "?subdomain=signiant");
        ViewData["accountProfileEdit"] = string.Concat(ViewData["accountProfileEdit"], "?subdomain=signiant");
    }
    else if (requestUrl.Contains("aspera"))
    {
        ViewData["accountSignIn"] = string.Concat(ViewData["accountSignIn"], "?subdomain=aspera");
        ViewData["accountProfileEdit"] = string.Concat(ViewData["accountProfileEdit"], "?subdomain=aspera");
    }

    ViewData["spokenLanguages"] = Language.GetSpokenLanguages();

    Layout = "_Layout";
}
