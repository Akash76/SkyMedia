pipeline {
  agent any
  parameters {
    string(name: 'GITHUB_APP_CREDENTIAL_ID', defaultValue: 'GitHubAppKey')
    string(name: 'GITHUB_APP_TOKEN_SECONDS', defaultValue: '300')
    string(name: 'GITHUB_API_HEADER_ACCEPT_AUTH', defaultValue: 'application/vnd.github.machine-man-preview+json')
    string(name: 'GITHUB_API_HEADER_ACCEPT_CHECK', defaultValue: 'application/vnd.github.antiope-preview+json')
    string(name: 'TF_BACKEND_CONFIG_FILE', defaultValue: '/tfBackendConfig.txt')
    booleanParam(name: 'TF_IN_AUTOMATION', defaultValue: true)
  }
  options {
    disableConcurrentBuilds()
  }
  triggers {
    GenericTrigger(
      genericHeaderVariables: [
        [key: 'x-github-event']
      ],
      genericVariables: [
        [key: 'GITHUB_EVENT_ACTION', value: '$.action'],
        [key: 'GITHUB_APP_INSTALLATION_ID', value: '$.installation.id'],
        [key: 'GITHUB_PULL_REQUEST_ID', value: '$.pull_request.number'],
        [key: 'GITHUB_PULL_REQUEST_HASH', value: '$.pull_request.head.sha'],
        [key: 'GITHUB_PULL_REQUEST_BRANCH', value: '$.pull_request.head.ref'],
        [key: 'GITHUB_PULL_REQUEST_REPOSITORY_URL', value: '$.pull_request.head.repo.url'],
        [key: 'GITHUB_PULL_REQUEST_REPOSITORY_HOST', value: '$.pull_request.head.repo.url', regexpFilter: '(/repos)(.*)'],
        [key: 'GITHUB_PULL_REQUEST_REPOSITORY_NAME', value: '$.pull_request.head.repo.name']
      ],
      causeString: 'Pull Request $GITHUB_PULL_REQUEST_ID $GITHUB_EVENT_ACTION on $GITHUB_PULL_REQUEST_BRANCH branch in $GITHUB_PULL_REQUEST_REPOSITORY_NAME repository',
      regexpFilterExpression: '(pull_request).(opened|reopened|synchronize)',
      regexpFilterText: '$x_github_event.$GITHUB_EVENT_ACTION'
    )
  }
  stages {
    stage('GitHub Pull Request') {
      steps {
        sh '''#!/bin/bash -ex
          git clean -dff
          for changedFile in $(git diff --name-only $GIT_COMMIT $GITHUB_PULL_REQUEST_HASH)
          do
            if [ ${changedFile: -3} == ".tf" ]
            then
              echo -n "$(dirname $changedFile)" > tfFileDirectory.txt
              echo -n "$changedFile" > tfFilePath.txt
              break
            fi
          done
        '''
      }
    }
    stage('GitHub App Token') {
      when {
        expression {
          fileExists('tfFilePath.txt')
        }
      }
      environment {
        GITHUB_APP_KEY_FILE = credentials("$GITHUB_APP_CREDENTIAL_ID")
        GITHUB_APP_WEB_TOKEN = sh(script: "python3 $WORKSPACE/GetWebToken.py $GITHUB_APP_KEY_USR $GITHUB_APP_KEY_FILE $GITHUB_APP_TOKEN_SECONDS 'RS256'", returnStdout: true)
      }
      steps {
        script {
          def httpResponse = httpRequest url: "$GITHUB_PULL_REQUEST_REPOSITORY_HOST/installations/$GITHUB_APP_INSTALLATION_ID/access_tokens", httpMode: 'POST', customHeaders: [[name: 'Accept', value: "$GITHUB_API_HEADER_ACCEPT_AUTH"],[name: 'Authorization', value: "Bearer $GITHUB_APP_WEB_TOKEN"]]
          def jsonResponse = readJSON text: httpResponse.content
          writeFile file: 'appInstallationToken.txt', text: jsonResponse.token
        }
      }
    }
    stage('Terraform Init') {
      when {
        expression {
          fileExists('appInstallationToken.txt')
        }
      }
      steps {
        script {
          def checkRunConclusion
          def checkRunOutputSummary
          def appInstallationToken = readFile file: 'appInstallationToken.txt'
          httpResponse = httpRequest url: "$GITHUB_PULL_REQUEST_REPOSITORY_URL/check-runs", httpMode: 'POST', customHeaders: [[name: 'Accept', value: "$GITHUB_API_HEADER_ACCEPT_CHECK"],[name: 'Authorization', value: "token $appInstallationToken"]], requestBody: "{\"name\":\"Terraform Init\", \"head_sha\":\"$GITHUB_PULL_REQUEST_HASH\", \"status\":\"in_progress\"}"
          jsonResponse = readJSON text: httpResponse.content
          def checkRunId = jsonResponse.id
          try {
            sh '''#!/bin/bash -ex
              tfStateFile="$(sed 's|/|-|g' tfFilePath.txt)state"
              cd $(cat tfFileDirectory.txt)
              echo 'terraform {' > backend.tf
              echo 'backend "azurerm" {}' >> backend.tf
              echo '}' >> backend.tf
              terraform init -input=false -backend-config="$WORKSPACE$TF_BACKEND_CONFIG_FILE" -backend-config="key=$tfStateFile" -no-color &> tfOutputInit.txt
            '''
            def tfFileDirectory = readFile file: 'tfFileDirectory.txt'
            dir(tfFileDirectory) {
              def tfOutputInit = readFile file: 'tfOutputInit.txt'
              tfOutputInit = tfOutputInit.replaceAll('"', "'")
              tfOutputInit = tfOutputInit.replaceAll('\n', '<br>')
              checkRunOutputSummary = tfOutputInit
            }
            checkRunConclusion = 'success'
          }
          catch (err) {
            checkRunOutputSummary = err
            checkRunConclusion = 'failure'
            currentBuild.currentResult = 'FAILURE'
          }
          finally {
            def tfFilePath = readFile file: 'tfFilePath.txt'
            def checkRunName = 'Terraform Init'
            def checkRunOutputTitle = "$checkRunName ($tfFilePath)"
            httpRequest url: "$GITHUB_PULL_REQUEST_REPOSITORY_URL/check-runs/$checkRunId", httpMode: 'PATCH', customHeaders: [[name: 'Accept', value: "$GITHUB_API_HEADER_ACCEPT_CHECK"],[name: 'Authorization', value: "token $appInstallationToken"]], requestBody: "{\"name\":\"$checkRunName\", \"conclusion\":\"$checkRunConclusion\", \"output\":{\"title\":\"$checkRunOutputTitle\", \"summary\":\"$checkRunOutputSummary\"}}"
          }
        }
      }
    }
    stage('Terraform Plan') {
      when {
        expression {
          fileExists('appInstallationToken.txt')
        }
      }
      steps {
        script {
          def checkRunConclusion
          def checkRunOutputSummary
          def appInstallationToken = readFile file: 'appInstallationToken.txt'
          httpResponse = httpRequest url: "$GITHUB_PULL_REQUEST_REPOSITORY_URL/check-runs", httpMode: 'POST', customHeaders: [[name: 'Accept', value: "$GITHUB_API_HEADER_ACCEPT_CHECK"],[name: 'Authorization', value: "token $appInstallationToken"]], requestBody: "{\"name\":\"Terraform Init\", \"head_sha\":\"$GITHUB_PULL_REQUEST_HASH\", \"status\":\"in_progress\"}"
          jsonResponse = readJSON text: httpResponse.content
          def checkRunId = jsonResponse.id
          try {
            sh '''#!/bin/bash -ex
              cd $(cat tfFileDirectory.txt)
              terraform plan -input=false -out=tfPlan.bin -no-color &> tfOutputPlan.txt
            '''
            def tfFileDirectory = readFile file: 'tfFileDirectory.txt'
            dir(tfFileDirectory) {
              def tfOutputPlan = readFile file: 'tfOutputPlan.txt'
              tfOutputPlan = tfOutputPlan.replaceAll('"', "'")
              tfOutputPlan = tfOutputPlan.replaceAll('\n', '<br>')
              checkRunOutputSummary = tfOutputPlan
            }
            checkRunConclusion = 'success'
          }
          catch (err) {
            checkRunOutputSummary = err
            checkRunConclusion = 'failure'
            currentBuild.currentResult = 'FAILURE'
          }
          finally {
            def tfFilePath = readFile file: 'tfFilePath.txt'
            def checkRunName = 'Terraform Plan'
            def checkRunOutputTitle = "$checkRunName ($tfFilePath)"
            httpRequest url: "$GITHUB_PULL_REQUEST_REPOSITORY_URL/check-runs/$checkRunId", httpMode: 'PATCH', customHeaders: [[name: 'Accept', value: "$GITHUB_API_HEADER_ACCEPT_CHECK"],[name: 'Authorization', value: "token $appInstallationToken"]], requestBody: "{\"name\":\"$checkRunName\", \"conclusion\":\"$checkRunConclusion\", \"output\":{\"title\":\"$checkRunOutputTitle\", \"summary\":\"$checkRunOutputSummary\"}}"
          }
        }
      }
    }
    stage('Build Artifacts Storage') {
      when {
        expression {
          fileExists('tfFileDirectory.txt')
        }
        expression {
          dir(readFile('tfFileDirectory.txt')) {
            fileExists('tfPlan.bin')
          }
        }
      }
      steps {
        dir(readFile('tfFileDirectory.txt')) {
          //archiveArtifacts artifacts: '**'
        }
      }
    }
  }
}
